<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>KPC 電腦估價車系統</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  <!-- jQuery & Select2 for 型號搜尋 -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    /* ...（你的原本 CSS 全部保留）... */
    .spec-table select {
      width: 100%;
      font-size: 1rem;
      padding: 3px 2px;
      border-radius: 4px;
      border: 1px solid #c6e6f2;
      background: #fff;
    }
    /* select2 美化細節 */
    .select2-container .select2-selection--single {
      height: 36px !important;
      padding: 4px 0;
      font-size: 1rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 36px !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 36px !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ...（原本內容）... -->
    <form id="partsForm">
      <table class="spec-table" id="specTable">
        <tr>
          <th class="cat">配件類別</th>
          <th class="model">型號</th>
          <th class="qty">數量</th>
          <th class="model">價格</th>
        </tr>
      </table>
    </form>
    <!-- ...（原本內容）... -->
  </div>
  <script>
    function calcDiscount(total) { return Math.round(total * 0.95); }
    let selectedModels = {}; let quantities = {};

    function genSelectId(catIdx) { return 'modelSelect' + catIdx; }

    function renderPartsTable() {
      const partsData = JSON.parse(localStorage.getItem('partsData') || "[]");
      const table = document.getElementById('specTable');
      table.innerHTML = `
        <tr>
          <th class="cat">配件類別</th>
          <th class="model">型號</th>
          <th class="qty">數量</th>
          <th class="model">價格</th>
        </tr>
      `;
      let oriTotal = 0;
      partsData.forEach((cat, catIdx) => {
        let selectId = genSelectId(catIdx);
        let selectHtml = `<select id="${selectId}" data-cat="${catIdx}">`;
        let allModels = [];
        // subcategories
        if (cat.subcategories && Array.isArray(cat.subcategories) && cat.subcategories.length > 0) {
          cat.subcategories.forEach((subcat, subIdx) => {
            if (subcat.models && subcat.models.length > 0) {
              selectHtml += `<optgroup label="${subcat.name}">`;
              subcat.models.forEach((m, mIdx) => {
                let label = (m.model || '').replace(/[,，].*$/, '');
                let sel = (allModels.length === (selectedModels[catIdx] || 0)) ? 'selected' : '';
                selectHtml += `<option value="${allModels.length}" ${sel}>${label}</option>`;
                allModels.push({ subIdx, mIdx, price: m.price, model: m.model });
              });
              selectHtml += `</optgroup>`;
            }
          });
        } else if (cat.models && Array.isArray(cat.models) && cat.models.length > 0) {
          cat.models.forEach((m, mIdx) => {
            let label = (m.model || '').replace(/[,，].*$/, '');
            let sel = (allModels.length === (selectedModels[catIdx] || 0)) ? 'selected' : '';
            selectHtml += `<option value="${allModels.length}" ${sel}>${label}</option>`;
            allModels.push({ subIdx:0, mIdx, price: m.price, model: m.model });
          });
        }
        selectHtml += "</select>";

        let selectIdx = selectedModels[catIdx] || 0;
        if (selectIdx >= allModels.length) selectIdx = 0;
        let selected = allModels[selectIdx] || {};
        let price = selected.price ? Number(selected.price) : 0;
        let qty = quantities[catIdx] !== undefined ? Number(quantities[catIdx]) : 1;
        if(qty < 1) qty = 1;
        oriTotal += price * qty;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="cat">${cat.name}</td>
          <td class="model">${allModels.length > 0 ? selectHtml : '<span style="color:#aaa;">（無型號）</span>'}</td>
          <td class="qty">
            <input type="number" min="1" value="${qty}" data-cat="${catIdx}" onchange="onQtyChange(this)">
          </td>
          <td class="price-cell">${price ? '$ ' + price.toLocaleString() : ''}</td>
        `;
        table.appendChild(tr);
      });

      document.getElementById('oriPrice').textContent = "$ " + oriTotal.toLocaleString();
      const nowPrice = calcDiscount(oriTotal);
      document.getElementById('nowPrice').textContent = "$ " + nowPrice.toLocaleString();
      document.getElementById('priceNote').textContent = "*實際優惠依現場公告";
      showInstallments(nowPrice);

      // 初始化 Select2 型號搜尋
      setTimeout(function(){
        $('select[id^="modelSelect"]').each(function(){
          if ($(this).hasClass('select2-hidden-accessible')) {
            $(this).select2('destroy');
          }
        });
        $('select[id^="modelSelect"]').select2({
          width: 'resolve',
          dropdownAutoWidth: true,
          minimumResultsForSearch: 0,
          placeholder: "請搜尋或選擇型號"
        }).off('change').on('change', function(){
          const catIdx = $(this).attr('data-cat');
          selectedModels[catIdx] = Number($(this).val());
          renderPartsTable();
        });
      }, 0);
    }

    function onQtyChange(input) {
      const catIdx = input.getAttribute('data-cat');
      let val = Number(input.value);
      if(val < 1) val = 1;
      quantities[catIdx] = val;
      renderPartsTable();
    }
    window.onQtyChange = onQtyChange;

    function showInstallments(nowPrice) {
      const cardRates = [
        {term: "付清", rate: 1, fee: 0},
        {term: "3期", rate: 1.03, fee: 0},
        {term: "6期", rate: 1.035, fee: 0},
        {term: "12期", rate: 1.06, fee: 0},
        {term: "24期", rate: 1.06, fee: 0}
      ];
      const noCardRates = [
        {term: "6期", rate: 1.026, fee: 0},
        {term: "9期", rate: 1.055, fee: 0},
        {term: "12期", rate: 1.065, fee: 0},
        {term: "15期", rate: 1.073, fee: 0},
        {term: "18期", rate: 1.09, fee: 0},
        {term: "21期", rate: 1.115, fee: 0},
        {term: "24期", rate: 1.115, fee: 0},
        {term: "30期", rate: 1.12, fee: 0}
      ];
      const cardTable = document.getElementById('cardTable');
      cardTable.innerHTML = `
        <tr>
          <th colspan="3">刷卡分期</th>
        </tr>
        <tr>
          <th>期數</th>
          <th>總價</th>
          <th>每期</th>
        </tr>
      `;
      cardRates.forEach(r => {
        const total = Math.round(nowPrice * r.rate + r.fee);
        const per = Math.ceil(total / (parseInt(r.term) || 1));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.term}</td>
          <td>$ ${total.toLocaleString()}</td>
          <td>$ ${r.term === "付清" ? total.toLocaleString() : per.toLocaleString()}</td>
        `;
        cardTable.appendChild(tr);
      });
      const noCardTable = document.getElementById('noCardTable');
      noCardTable.innerHTML = `
        <tr>
          <th colspan="3">無卡分期</th>
        </tr>
        <tr>
          <th>期數</th>
          <th>總價</th>
          <th>每期</th>
        </tr>
      `;
      noCardRates.forEach(r => {
        const total = Math.round(nowPrice * r.rate + r.fee);
        const per = Math.ceil(total / (parseInt(r.term) || 1));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.term}</td>
          <td>$ ${total.toLocaleString()}</td>
          <td>$ ${per.toLocaleString()}</td>
        `;
        if(r.term === "30期") tr.querySelectorAll('td').forEach(td=>td.classList.add('red'));
        noCardTable.appendChild(tr);
      });
    }

    function loadSelectedModels() {
      const partsData = JSON.parse(localStorage.getItem('partsData') || "[]");
      selectedModels = {};
      quantities = {};
      partsData.forEach((cat, catIdx) => {
        selectedModels[catIdx] = 0;
        quantities[catIdx] = 1;
      });
    }

    function updatePage() {
      loadSelectedModels();
      renderPartsTable();
    }

    updatePage();
    window.addEventListener('storage', function(e){
      if(e.key === "partsData") updatePage();
    });
  </script>
</body>
</html>
